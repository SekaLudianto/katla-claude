<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Live Wordle</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat ikon (untuk tombol kirim) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
/* ... existing code ... -->
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* bg-gray-400 */
        }
        
        /* Animasi untuk Pemenang */
        @keyframes zoomInFade {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .animate-winner {
            animation: zoomInFade 0.5s ease-out forwards;
        }
        
        /* --- FITUR ABSURD --- */
        .absurd-difficulty {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-black text-white flex flex-col h-screen overflow-hidden">

    <!-- 1. Navigasi Tab -->
    <nav class="flex border-b border-gray-700 bg-black sticky top-0 z-10">
        <button id="tab-connect" class="flex-1 py-3 px-4 text-center font-semibold bg-gray-800 text-white transition-colors duration-200">
            Koneksi
        </button>
        <button id="tab-game" class="flex-1 py-3 px-4 text-center font-semibold text-gray-400 hover:bg-gray-800 transition-colors duration-200">
            Permainan
        </button>
        <button id="tab-ranking" class="flex-1 py-3 px-4 text-center font-semibold text-gray-400 hover:bg-gray-800 transition-colors duration-200">
            Peringkat
        </button>
    </nav>

    <!-- 2. Konten Utama (Game + Chat) -->
    <main class="flex-grow flex flex-col overflow-hidden">
        
        <!-- 2.1. Konten Tab Koneksi (Aktif secara default) -->
        <div id="content-connect" class="flex flex-col h-full">
            <!-- Umpan Pesan Game/Koneksi -->
            <div id="message-feed" class="flex-grow h-40 lg:h-48 overflow-y-auto p-4 flex flex-col-reverse space-y-2 space-y-reverse">
                <!-- Pesan status game akan muncul di sini -->
            </div>
            
            <!-- Input Bar Koneksi -->
            <footer class="p-3 border-t border-gray-700 bg-black sticky bottom-0 z-10">
                <div class="flex items-center space-x-2">
                    <input type="text" id="tiktok-username-input" class="flex-grow bg-gray-800 rounded-full px-4 py-2 text-white outline-none placeholder-gray-500" placeholder="...EVIL gnades gnay koTkiT emanresu@ nakussaM" dir="rtl">
                    <button id="connect-button" class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
            </footer>
        </div>
        
        <!-- 2.2. Konten Tab Permainan (Tersembunyi secara default) -->
        <div id="content-game" class="hidden flex flex-col h-full">
            <!-- Judul Game -->
            <div class="p-3 text-center bg-gray-900 sticky top-0 z-10 flex-shrink-0">
                <h2 class="text-lg font-extrabold text-yellow-400">WORDLE 6 HURUF</h2>
                <p id="game-status" class="text-sm text-gray-300">Memuat kosakata...</p>
                <div id="word-display" class="hidden text-xl font-bold text-green-500 mt-2"></div>
            </div>

            <!-- Papan Permainan -->
            <div id="game-board" class="flex-grow overflow-y-auto p-4 space-y-2 absurd-difficulty">
                <!-- Baris tebakan akan ditambahkan di sini oleh JS -->
            </div>

            <!-- Pemisah -->
            <div class="border-t border-gray-700 mx-4 flex-shrink-0"></div>
        </div>

        <!-- 2.3. Konten Tab Peringkat (Tersembunyi secara default) -->
        <div id="content-ranking" class="hidden flex flex-col h-full p-4 overflow-y-auto">
            <h2 class="text-lg font-extrabold text-yellow-400 text-center mb-4">TOP 5 PEMENANG</h2>
            <div id="leaderboard-content" class="space-y-3">
                <!-- Peringkat akan dimuat di sini oleh JS -->
                <p class="text-gray-400 text-center">Memuat peringkat...</p>
            </div>
        </div>

    </main>

    <!-- 3. Overlay Perayaan Pemenang (Tersembunyi) -->
    <div id="winner-celebration" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 border-4 border-yellow-400 rounded-lg p-8 shadow-xl text-center animate-winner">
            <h2 class="text-3xl font-bold text-yellow-400 mb-4">JUARA 1!</h2>
            <img id="winner-img" src="" alt="Pemenang" class="w-24 h-24 rounded-full mx-auto border-4 border-white mb-4">
            <p id="winner-name" class="text-2xl font-semibold text-white mb-2"></p>
            <p id="winner-points" class="text-xl text-green-400 font-bold"></p>
        </div>
    </div>


    <script type="module">
        // --- IMPORT FIREBASE ---
        // Menggunakan v12.5.0 sesuai permintaan Anda
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, runTransaction, query, setLogLevel } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";

        // --- KONFIGURASI FIREBASE (Sesuai permintaan Anda) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBmkg2rZNL0D_lpF2QMZmgle4ASTrIT_r0", // DARI ANDA
            authDomain: "kuis-tiktok-c9272.firebaseapp.com", // DARI ANDA
            projectId: "kuis-tiktok-c9272", // DARI ANDA
            storageBucket: "kuis-tiktok-c9272.firebasestorage.app", // DARI ANDA
            messagingSenderId: "534386964257", // DARI ANDA
            appId: "1:534386964257:web:daa7851240222b80baf060", // DARI ANDA
            measurementId: "G-BK1DG45JXC" // DARI ANDA
        };

        // --- Inisialisasi Firebase ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // Sesuai permintaan Anda
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Aktifkan log Firebase

        // --- Variabel Global Firebase ---
// Hapus 'appId' karena tidak relevan untuk Firebase kustom
        let userId = null; // Akan diisi oleh auth
        let scoresCollectionPath = '';


        document.addEventListener('DOMContentLoaded', () => {
            // --- AMBIL APP ID DARI CANVAS (JIKA ADA) ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // --- URL BACKEND ---
            const WSS_URL = 'wss://tiktok-server-claude-production.up.railway.app';
            let ws; // WebSocket connection

            // --- ELEMEN DOM ---
            const gameBoard = document.getElementById('game-board');
            const messageFeed = document.getElementById('message-feed');
            const tiktokUsernameInput = document.getElementById('tiktok-username-input');
            const connectButton = document.getElementById('connect-button');
            const gameStatus = document.getElementById('game-status');
            const wordDisplay = document.getElementById('word-display');
            
            // --- ELEMEN TAB BARU ---
            const tabConnect = document.getElementById('tab-connect');
            const tabGame = document.getElementById('tab-game');
            const tabRanking = document.getElementById('tab-ranking'); // TAB BARU
            const contentConnect = document.getElementById('content-connect');
            const contentGame = document.getElementById('content-game');
            const contentRanking = document.getElementById('content-ranking'); // KONTEN BARU
            const leaderboardContent = document.getElementById('leaderboard-content'); // KONTEN BARU

            // --- ELEMEN PEMENANG BARU ---
            const winnerCelebration = document.getElementById('winner-celebration');
            const winnerImg = document.getElementById('winner-img');
            const winnerName = document.getElementById('winner-name');
            const winnerPoints = document.getElementById('winner-points');

            // --- DATA KATA ---
            let wordList = []; // Daftar kata master
            let sessionWordList = []; // Daftar kata untuk sesi ini (akan berkurang)
            let definitions = new Map(); // Untuk menyimpan arti kata
            
            // Pengguna default untuk placeholder
            const defaultAvatar = 'https://placehold.co/40x40/ffffff/000000?text=U'; // 'U' untuk User

            // --- STATUS GAME ---
            let targetWord = "";
            let targetDefinition = ""; // Menyimpan arti kata
            let gameWon = false; // Menandakan ronde ini sudah dimenangkan (oleh juara 1)
            let currentUniqueId = ''; // Menyimpan ID pengguna terakhir untuk reconnect
            let roundWinners = []; // Menyimpan [ {user, points}, ... ] untuk ronde ini

            // --- FUNGSI UTAMA ---

            /** Fungsi untuk beralih antar tab */
            function showTab(tabName) {
                // Sembunyikan semua konten
                contentConnect.classList.add('hidden');
                contentGame.classList.add('hidden');
                contentGame.classList.remove('flex');
                contentRanking.classList.add('hidden');
                contentRanking.classList.remove('flex');

                // Atur ulang semua tab
                tabConnect.classList.remove('bg-gray-800', 'text-white');
                tabConnect.classList.add('text-gray-400', 'hover:bg-gray-800');
                tabGame.classList.remove('bg-gray-800', 'text-white');
                tabGame.classList.add('text-gray-400', 'hover:bg-gray-800');
                tabRanking.classList.remove('bg-gray-800', 'text-white');
                tabRanking.classList.add('text-gray-400', 'hover:bg-gray-800');

                // Tampilkan yang aktif
                if (tabName === 'game') {
                    contentGame.classList.remove('hidden');
                    contentGame.classList.add('flex');
                    tabGame.classList.add('bg-gray-800', 'text-white');
                    tabGame.classList.remove('text-gray-400', 'hover:bg-gray-800');
                } else if (tabName === 'ranking') {
                    contentRanking.classList.remove('hidden');
                    contentRanking.classList.add('flex');
                    tabRanking.classList.add('bg-gray-800', 'text-white');
                    tabRanking.classList.remove('text-gray-400', 'hover:bg-gray-800');
                } else { // 'connect'
                    contentConnect.classList.remove('hidden');
                    tabConnect.classList.add('bg-gray-800', 'text-white');
                    tabConnect.classList.remove('text-gray-400', 'hover:bg-gray-800');
                }
            }


            /** Ambil daftar kata dari JSON */
            async function fetchWordList() {
                gameStatus.textContent = "Memuat kosakata dari server...";
                try {
                    const response = await fetch('https://raw.githubusercontent.com/SekaLudianto/katla-claude/refs/heads/main/kosakata.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    wordList = [];
                    definitions.clear();

                    data.forEach(item => {
                        // Filter hanya untuk kata 6 huruf
                        if (item.kata && item.kata.length === 6) {
                            const word = item.kata.toUpperCase();
                            wordList.push(word);
                            definitions.set(word, item.arti || "Tidak ada definisi.");
                        }
                    });

                    if (wordList.length === 0) {
                        throw new Error("Tidak ada kata 6 huruf yang ditemukan.");
                    }
                    
                    // Salin ke daftar sesi
                    sessionWordList = [...wordList];
                    // Acak daftar sesi
                    sessionWordList.sort(() => Math.random() - 0.5); 

                } catch (error) {
                    console.error("Gagal memuat kosakata:", error);
                    gameStatus.textContent = "Gagal memuat kosakata. Menggunakan daftar cadangan.";
                    // Daftar cadangan jika fetch gagal
                    wordList = ["ENAM", "HURUF", "KATA", "COBA", "MAIN", "KEREN"];
                    wordList.forEach(word => definitions.set(word, "Kata cadangan."));
                    sessionWordList = [...wordList].sort(() => Math.random() - 0.5);
                }
            }

            /** Inisialisasi permainan baru */
            function initGame() {
                // Cek jika kata sudah habis
                if (sessionWordList.length === 0) {
                    gameStatus.textContent = "Permainan Selesai!";
                    addGameMessage("Semua kata telah ditebak! Terima kasih sudah bermain.", "host");
                    wordDisplay.textContent = "LIHAT TAB PERINGKAT UNTUK SKOR AKHIR!";
                    wordDisplay.classList.remove('hidden');
                    gameWon = true; // Hentikan permainan
                    return;
                }

                // Ambil 1 kata dari daftar sesi dan hapus
                targetWord = sessionWordList.pop(); 
                
                targetDefinition = definitions.get(targetWord);
                gameWon = false;
                roundWinners = []; // Kosongkan pemenang ronde
                gameBoard.innerHTML = '';
                
                const level = wordList.length - sessionWordList.length;
                const totalLevels = wordList.length;
                gameStatus.textContent = `Level ${level}/${totalLevels} | Tebak kata 6 huruf!`;
                
                wordDisplay.classList.add('hidden');
                
                addGameMessage(`Level ${level} dimulai! Menunggu tebakan dari chat...`, 'host');
            }


            /** Menghubungkan ke TikTok Live via WebSocket */
            function connectToTikTok() {
                const uniqueIdFromInput = tiktokUsernameInput.value.trim().replace('@', '');
                const uniqueIdToUse = uniqueIdFromInput || currentUniqueId;

                if (!uniqueIdToUse) {
                    addGameMessage('Masukkan @username TikTok yang valid.', 'error');
                    return;
                }
                
                currentUniqueId = uniqueIdToUse; 

                if (ws) {
                    ws.close(); 
                }

                addGameMessage(`Menyambung ke ${WSS_URL}...`, 'host');
                ws = new WebSocket(WSS_URL);

                ws.onopen = () => {
                    addGameMessage('Koneksi server berhasil. Menghubungkan ke TikTok...', 'host');
                    ws.send(JSON.stringify({
                        type: 'connect',
                        uniqueId: currentUniqueId 
                    }));
                    tiktokUsernameInput.disabled = true;
                    connectButton.disabled = true;
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleSocketMessage(data); // Proses pesan dari server
                    } catch(e) {
                        console.error("Pesan WS tidak valid:", event.data);
                    }
                };

                ws.onclose = () => {
                    addGameMessage('Koneksi ke server terputus. Mencoba menyambung kembali...', 'error');
                    
                    // Aktifkan kembali input
                    tiktokUsernameInput.disabled = false;
                    connectButton.disabled = false;
                    tiktokUsernameInput.value = currentUniqueId; 

                    // Nonaktifkan tab game/peringkat dan kembali ke tab koneksi
                    tabGame.disabled = true;
                    tabGame.classList.add('opacity-50', 'cursor-not-allowed');
                    tabRanking.disabled = true;
                    tabRanking.classList.add('opacity-50', 'cursor-not-allowed');
                    showTab('connect');

                    // Coba sambungkan kembali secara otomatis setelah 3 detik
                    setTimeout(connectToTikTok, 3000);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket Error:', error);
                    addGameMessage('Koneksi WebSocket gagal.', 'error');
                    
                    // Aktifkan kembali input
                    tiktokUsernameInput.disabled = false;
                    connectButton.disabled = false;
                    tiktokUsernameInput.value = currentUniqueId; 

                    // Nonaktifkan tab game/peringkat dan kembali ke tab koneksi
                    tabGame.disabled = true;
                    tabGame.classList.add('opacity-50', 'cursor-not-allowed');
                    tabRanking.disabled = true;
                    tabRanking.classList.add('opacity-50', 'cursor-not-allowed');
                    showTab('connect');
                };
            }

            /** Memproses pesan yang datang dari WebSocket Server */
            function handleSocketMessage(data) {
                switch (data.type) {
                    case 'connected':
                        addGameMessage(`Terhubung ke Live @${data.uniqueId}! Menunggu tebakan 6 huruf dari chat...`, 'host');
                        
                        // Aktifkan tab game/peringkat dan pindah ke sana
                        tabGame.disabled = false;
                        tabGame.classList.remove('opacity-50', 'cursor-not-allowed');
                        tabRanking.disabled = false;
                        tabRanking.classList.remove('opacity-50', 'cursor-not-allowed');
                        showTab('game'); // Otomatis pindah ke tab game

                        initGame();
                        break;
                    case 'chat':
                        const guess = data.message.trim().toUpperCase();
                        const user = {
                            userId: data.userId, // ID unik dari TikTok (PENTING)
                            name: data.nickname || data.username,
                            avatar: data.profilePictureUrl || defaultAvatar
                        };

                        if (!user.userId) {
                            console.warn("Pesan chat tanpa userId:", data);
                            return; // Butuh userId untuk skor
                        }
                        
                        // Cek tebakan valid (6 huruf, A-Z)
                        if (guess.length === 6 && /^[A-Z]+$/.test(guess)) {
                            handleGuess(guess, user); 
                        }
                        break;
                    case 'gift':
                        addGameMessage(`Terima kasih ${data.nickname} untuk ${data.giftName}-nya!`, 'gift');
                        break;
                    case 'like':
                        // addGameMessage(`${data.nickname} mengirim ${data.likeCount} like!`, 'like');
                        break;
                    case 'follow':
                        addGameMessage(`${data.nickname} baru saja follow!`, 'follow');
                        break;
                    case 'streamEnd':
                        addGameMessage('Siaran langsung telah berakhir.', 'error');
                        if (ws) ws.close();
                        // Nonaktifkan tab game/peringkat dan kembali ke tab koneksi
                        tabGame.disabled = true;
                        tabGame.classList.add('opacity-50', 'cursor-not-allowed');
                        tabRanking.disabled = true;
                        tabRanking.classList.add('opacity-50', 'cursor-not-allowed');
                        showTab('connect');
                        break;
                    case 'error':
                        addGameMessage(`Error: ${data.message}`, 'error');
                        if (ws) ws.close();
                         // Nonaktifkan tab game/peringkat dan kembali ke tab koneksi
                        tabGame.disabled = true;
                        tabGame.classList.add('opacity-50', 'cursor-not-allowed');
                        tabRanking.disabled = true;
                        tabRanking.classList.add('opacity-50', 'cursor-not-allowed');
                        showTab('connect');
                        break;
                }
            }


            /** Memproses tebakan Wordle */
            function handleGuess(guess, user) {
                // Tampilkan tebakan di papan
                const row = document.createElement('div');
                row.className = 'flex items-center space-x-2 w-full max-w-md mx-auto animate-fadeIn absurd-difficulty'; // <--- ROTATE ROW
                
                let gridHtml = '<div class="grid grid-cols-6 gap-1 flex-grow">';
                
                const guessChars = guess.split('');
                const targetChars = targetWord.split('');
                
                let tiles = []; 
                let targetBank = [...targetChars]; 

                // Pass 1: Cek Hijau (Correct)
                for (let i = 0; i < 6; i++) {
                    if (guessChars[i] === targetChars[i]) {
                        tiles[i] = { status: 'correct', char: guessChars[i] };
                        targetBank[i] = null; 
                    } else {
                        tiles[i] = { status: 'absent', char: guessChars[i] };
                    }
                }

                // Pass 2: Cek Kuning (Present) & Abu-abu (Absent)
                for (let i = 0; i < 6; i++) {
                    if (tiles[i].status !== 'correct') {
                        const charIndexInBank = targetBank.indexOf(guessChars[i]);
                        
                        if (charIndexInBank > -1) {
                            tiles[i].status = 'present';
                            targetBank[charIndexInBank] = null; 
                        }
                    }
                }
                
                // Buat HTML berdasarkan status ubin
                for (let i = 0; i < 6; i++) {
                    // --- LOGIKA WARNA ABSURD (DIBALIK) ---
                    let colorClass = 'bg-green-600 border-green-500'; // HIJAU untuk 'absent'
                    
                    if (tiles[i].status === 'correct') {
                        colorClass = 'bg-gray-700 border-gray-600'; // ABU-ABU untuk 'correct'
                    } else if (tiles[i].status === 'present') {
                        colorClass = 'bg-yellow-500 border-yellow-400'; // KUNING untuk 'present'
                    }
                    // --- AKHIR LOGIKA ABSURD ---
                    
                    gridHtml += `
                        <div class="w-9 h-9 md:w-11 md:h-11 border-2 ${colorClass} rounded-md flex items-center justify-center text-xl font-bold uppercase animate-reveal" style="animation-delay: ${i * 100}ms;">
                            ${tiles[i].char}
                        </div>
                    `;
                }
                gridHtml += '</div>';

                row.innerHTML = `
                    <img src="${user.avatar || defaultAvatar}" alt="${user.name}" class="w-8 h-8 rounded-full border-2 border-pink-500 flex-shrink-0" onerror="this.src='${defaultAvatar}'">
                    ${gridHtml}
                    <span class="text-xs font-semibold text-gray-400 w-16 truncate text-right">${user.name}</span>
                `;
                
                gameBoard.appendChild(row);
                gameBoard.scrollTop = gameBoard.scrollHeight;

                // --- LOGIKA SKOR BARU ---
                if (guess === targetWord) {
                    // Cek apakah pengguna ini sudah menang di ronde ini
                    if (roundWinners.find(w => w.userId === user.userId)) {
                        return; // Sudah menang, jangan proses lagi
                    }

                    // Tentukan poin
                    const points = 3 - roundWinners.length; // 3, 2, atau 1

                    if (points > 0) {
                        // Tambahkan ke daftar pemenang ronde
                        roundWinners.push({ ...user, points });
                        
                        // Update skor di Firebase
                        updateUserScore(user, points);

                        if (roundWinners.length === 1) {
                            // --- JUARA 1 ---
                            gameWon = true; // Kunci ronde
                            winGame(user, points); // Mulai perayaan dan timer
                        } else {
                            // --- JUARA 2 atau 3 ---
                            addGameMessage(`üéâ ${user.name} Juara ${roundWinners.length} (+${points} pts)!`, 'host');
                        }
                    }
                }
            }

            /** Menjalankan logika saat game dimenangkan (oleh Juara 1) */
            function winGame(user, points) {
                gameStatus.textContent = `üéâ ${user.name} Menemukan katanya! üéâ`;
                wordDisplay.textContent = `${targetWord}: ${targetDefinition}`;
                wordDisplay.classList.remove('hidden');

                // Tampilkan overlay perayaan
                celebrateWinner(user, points);

                addGameMessage(`Selamat ${user.name}! Artinya: "${targetDefinition}". Kata berikutnya dalam 10 detik...`, 'host');

                // Mulai game baru setelah 10 detik
                setTimeout(initGame, 10000);
            }

            /** Menampilkan overlay perayaan */
            function celebrateWinner(user, points) {
                winnerImg.src = user.avatar || defaultAvatar;
                winnerName.textContent = user.name;
                winnerPoints.textContent = `+${points} Poin!`;
                winnerCelebration.classList.remove('hidden');
                winnerCelebration.classList.add('flex');

                // Sembunyikan setelah 5 detik
                setTimeout(() => {
                    winnerCelebration.classList.add('hidden');
                    winnerCelebration.classList.remove('flex');
                }, 5000);
            }

            /** Menambahkan pesan ke feed obrolan */
            function addGameMessage(message, type = 'host') {
                const msgEl = document.createElement('div');
                msgEl.className = 'text-sm p-1 animate-fadeIn text-center';
                
                let icon = 'üì¢';
                let color = 'text-yellow-300';

                if (type === 'error') {
                    icon = '‚ùå';
                    color = 'text-red-400';
                } else if (type === 'gift') {
                    icon = 'üéÅ';
                    color = 'text-pink-400';
                } else if (type === 'follow') {
                    icon = '‚ù§Ô∏è';
                    color = 'text-blue-400';
                }
                
                msgEl.innerHTML = `<span class="${color} font-semibold">${icon} ${message}</span>`;
                
                messageFeed.prepend(msgEl); 
                
                if (messageFeed.children.length > 20) { // Tambah kapasitas pesan
                    messageFeed.removeChild(messageFeed.lastChild);
                }
            }

            // --- FUNGSI FIREBASE BARU ---

            /** Inisialisasi Firebase Auth dan Listener */
            async function initializeAppFirebase() {
                try {
                    // --- PERBAIKAN ---
                    // Error 'Missing or insufficient permissions' biasanya berarti
                    // aturan keamanan Firebase Anda tidak mengizinkan penulisan.
                    // Saya mengubah path database ke path 'public' standar
                    // yang biasanya diizinkan untuk data bersama.
                    scoresCollectionPath = `/artifacts/${appId}/public/data/wordleScores`;

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            console.log("Firebase Auth berhasil (Anonim), userId:", user.uid);
                            userId = user.uid; // Simpan userId global (untuk hak tulis)
                            // Setelah auth siap, pasang listener leaderboard
                            setupLeaderboardListener();
                        } else {
                            console.log("User signed out");
                            userId = null;
                        }
                    });

                    // --- PERBAIKAN ---
                    // Selalu login secara anonim ke project Firebase kustom Anda.
                    // `__initial_auth_token` hanya untuk database internal Canvas,
                    // sehingga menyebabkan error 'auth/custom-token-mismatch'.
                    await signInAnonymously(auth);


                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    addGameMessage("Gagal terhubung ke database skor.", "error");
                }
            }

            /** Pasang listener real-time ke leaderboard */
            function setupLeaderboardListener() {
                if (!db || !scoresCollectionPath) {
                    console.error("Firestore DB atau Path belum siap.");
                    return;
                }

                const q = query(collection(db, scoresCollectionPath));
                
                onSnapshot(q, (querySnapshot) => {
                    const scores = [];
                    querySnapshot.forEach((doc) => {
                        scores.push(doc.data());
                    });
                    
                    // Sortir di sisi klien (JS) - (Menghindari kebutuhan indeks komposit)
                    scores.sort((a, b) => (b.score || 0) - (a.score || 0));
                    
                    // Ambil Top 5
                    const top5 = scores.slice(0, 5);
                    
                    // Render ke UI
                    renderLeaderboard(top5);

                }, (error) => {
                    console.error("Leaderboard Snapshot Error:", error);
                    leaderboardContent.innerHTML = '<p class="text-red-400 text-center">Gagal memuat peringkat.</p>';
                });
            }

            /** Render UI Leaderboard */
            function renderLeaderboard(top5) {
                if (top5.length === 0) {
                    leaderboardContent.innerHTML = '<p class="text-gray-400 text-center">Belum ada yang mendapatkan skor.</p>';
                    return;
                }

                let html = '';
                top5.forEach((user, index) => {
                    const rank = index + 1;
                    let medal = 'bg-gray-600';
                    if (rank === 1) medal = 'bg-yellow-400';
                    if (rank === 2) medal = 'bg-gray-300';
                    if (rank === 3) medal = 'bg-yellow-600';
                    
                    html += `
                        <div class="flex items-center bg-gray-800 p-2 rounded-lg shadow">
                            <span class="w-8 h-8 rounded-full ${medal} flex items-center justify-center text-black font-bold text-lg mr-3">${rank}</span>
                            <img src="${user.avatar || user.profilePictureUrl || defaultAvatar}" alt="${user.name}" class="w-10 h-10 rounded-full mr-3 border-2 border-white" onerror="this.src='${defaultAvatar}'">
                            <div class="flex-grow">
                                <p class="font-semibold text-white truncate">${user.name || user.nickname}</p>
                            </div>
                            <span class="text-xl font-bold text-green-400">${user.score || 0} pts</span>
                        </div>
                    `;
                });
                leaderboardContent.innerHTML = html;
            }

            /** Update skor pengguna di Firebase menggunakan Transaksi */
            async function updateUserScore(user, points) {
                if (!db || !scoresCollectionPath || !user.userId) {
                    console.error("Gagal update skor, DB/Path/UserID tidak ada", user);
                    return;
                }

                // Gunakan TikTok userId sebagai ID Dokumen
                const userDocRef = doc(db, scoresCollectionPath, user.userId.toString());

                try {
                    await runTransaction(db, async (transaction) => {
                        const userDoc = await transaction.get(userDocRef);
                        
                        let currentScore = 0;
                        if (userDoc.exists()) {
                            currentScore = userDoc.data().score || 0;
                        }
                        
                        const newScore = currentScore + points;
                        
                        // Set/Update data pengguna
                        transaction.set(userDocRef, {
                            userId: user.userId,
                            name: user.name, // Selalu update nama
                            avatar: user.avatar, // Selalu update avatar
                            score: newScore
                        }, { merge: true });
                    });
                    console.log(`Skor untuk ${user.name} berhasil diupdate ke ${points} poin.`);
                } catch (error) {
                    console.error("Gagal update skor (Transaksi):", error);
                    addGameMessage(`Gagal menyimpan skor ${user.name}`, 'error');
                }
            }


            // --- EVENT LISTENERS ---
            connectButton.addEventListener('click', connectToTikTok);
            tiktokUsernameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    connectToTikTok();
                }
            });

            // Listener untuk Tab
            tabConnect.addEventListener('click', () => showTab('connect'));
            tabGame.addEventListener('click', () => {
                if (!tabGame.disabled) showTab('game');
            });
            tabRanking.addEventListener('click', () => {
                 if (!tabRanking.disabled) showTab('ranking');
            });


            /** Fungsi untuk memulai seluruh aplikasi */
            async function startup() {
                // 1. Inisialisasi Firebase
                await initializeAppFirebase();
                
                // 2. Ambil daftar kata
                await fetchWordList(); 
                addGameMessage('Kosakata siap. Masukkan @username TikTok Anda dan tekan Play.', 'host');
                
                // 3. Atur UI awal
                tabGame.disabled = true;
                tabGame.classList.add('opacity-50', 'cursor-not-allowed');
                tabRanking.disabled = true;
                tabRanking.classList.add('opacity-50', 'cursor-not-allowed');
                showTab('connect');
            }

            // --- MULAI GAME ---
            startup();
        });
    </script>
</body>
</html>



